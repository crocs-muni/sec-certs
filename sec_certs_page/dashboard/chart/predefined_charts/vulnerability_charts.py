"""Vulnerability analysis chart definitions.

This module provides predefined charts for vulnerability exposure and supply chain
risk analysis.

Charts included:
- CC certificates with CVEs (by category, by vendor)
- FIPS certificates with CVEs
- Transitive vulnerability analysis
- CVE distribution by category
"""

from uuid import uuid4

from ...types.chart import ChartType
from ...types.common import CollectionName
from ...types.filter import AggregationType
from ..config import AxisConfig, ChartConfig
from ..factory import ChartFactory

# =============================================================================
# Standard charts using derived fields (work with standard build_chart_pipeline)
# These can be created by users through the UI or used as predefined charts.
# =============================================================================


def create_cc_vulnerability_charts() -> list:
    """Create CC vulnerability charts using the standard derived fields system.

    These charts use cve_count, direct_transitive_cve_count, etc. derived fields
    which work with the standard build_chart_pipeline function.
    """
    charts = []

    # CVE Count by Category - PIE chart for distribution overview
    cve_by_category_pie_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-cve-distribution-by-category",
        title="CVE Distribution by Category",
        chart_type=ChartType.PIE,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="category", label="Category"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM),
        show_legend=True,
        show_grid=False,
    )
    charts.append(ChartFactory.create_chart(cve_by_category_pie_config))

    # CVE Count by Category - BAR with log scale for comparing magnitudes
    cve_by_category_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-cve-count-by-category",
        title="CVE Count by Category (Log Scale)",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="category", label="Category"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM, log_scale=True),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(cve_by_category_config))

    # CVE Count by Vendor - BAR with log scale (vendors have huge variance)
    cve_by_vendor_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-cve-count-by-vendor",
        title="CVE Count by Vendor (Log Scale)",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="manufacturer", label="Vendor"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM, log_scale=True),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(cve_by_vendor_config))

    # Transitive CVE Count by Category - PIE for distribution
    transitive_by_category_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-transitive-cve-by-category",
        title="Transitive CVE Exposure by Category",
        chart_type=ChartType.PIE,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="category", label="Category"),
        y_axis=AxisConfig(field="total_transitive_cve_count", label="Transitive CVEs", aggregation=AggregationType.SUM),
        show_legend=True,
        show_grid=False,
    )
    charts.append(ChartFactory.create_chart(transitive_by_category_config))

    # Average CVE Count by EAL Level - LINE to show trend across security levels
    avg_cve_by_eal_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-avg-cve-by-eal",
        title="Average CVE Count by EAL Level",
        chart_type=ChartType.LINE,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="heuristics.eal", label="EAL Level"),
        y_axis=AxisConfig(
            field="cve_count", label="Avg CVEs per Certificate", aggregation=AggregationType.AVG, log_scale=True
        ),
        show_legend=False,
        show_grid=True,
    )
    charts.append(ChartFactory.create_chart(avg_cve_by_eal_config))

    return charts


def create_fips_vulnerability_charts() -> list:
    """Create FIPS vulnerability charts using the standard derived fields system."""
    charts = []

    # CVE Distribution by Security Level - PIE for distribution overview
    cve_by_level_pie_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-cve-distribution-by-level",
        title="CVE Distribution by Security Level",
        chart_type=ChartType.PIE,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.level", label="Security Level"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM),
        show_legend=True,
        show_grid=False,
    )
    charts.append(ChartFactory.create_chart(cve_by_level_pie_config))

    # CVE Count by Security Level - BAR with log scale
    cve_by_level_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-cve-count-by-level",
        title="CVE Count by Security Level (Log Scale)",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.level", label="Security Level"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM, log_scale=True),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(cve_by_level_config))

    # CVE Count by Vendor - BAR with log scale (vendors have huge variance)
    cve_by_vendor_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-cve-count-by-vendor",
        title="CVE Count by Vendor (Log Scale)",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.vendor", label="Vendor"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM, log_scale=True),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(cve_by_vendor_config))

    # Average CVE Count by Standard - LINE to show trend across standards
    avg_cve_by_standard_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-avg-cve-by-standard",
        title="Average CVE Count by FIPS Standard",
        chart_type=ChartType.LINE,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.standard", label="FIPS Standard"),
        y_axis=AxisConfig(field="cve_count", label="Avg CVEs per Module", aggregation=AggregationType.AVG),
        show_legend=False,
        show_grid=True,
    )
    charts.append(ChartFactory.create_chart(avg_cve_by_standard_config))

    return charts
