"""Vulnerability analysis chart definitions.

This module provides predefined charts for vulnerability exposure and supply chain
risk analysis.

Charts included:
- CC: Total CVEs by category, average CVEs by EAL, transitive CVE exposure
- FIPS: CVE distribution by security level and standard
"""

from uuid import uuid4

from ...types.chart import ChartType
from ...types.common import CollectionName
from ...types.filter import AggregationType
from ..config import AxisConfig, ChartConfig
from ..factory import ChartFactory

# =============================================================================
# Standard charts using derived fields (work with standard build_chart_pipeline)
# These can be created by users through the UI or used as predefined charts.
# =============================================================================


def create_cc_vulnerability_charts() -> list:
    """Create CC vulnerability charts using the standard derived fields system.

    These charts use cve_count, direct_transitive_cve_count, etc. derived fields
    which work with the standard build_chart_pipeline function.
    """
    charts = []

    # Total CVE Count by Category - BAR chart (best for comparing categories)
    # Shows which product categories have the most associated vulnerabilities
    cve_by_category_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-cve-count-by-category",
        title="Total CVEs by Category",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="category", label="Category"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(cve_by_category_config))

    # Average CVE Count by Category - BAR chart
    # Normalizes by number of certificates to show vulnerability density
    avg_cve_by_category_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-avg-cve-by-category",
        title="Average CVEs per Certificate by Category",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="category", label="Category"),
        y_axis=AxisConfig(field="cve_count", label="Avg CVEs per Certificate", aggregation=AggregationType.AVG),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(avg_cve_by_category_config))

    # Average CVE Count by EAL Level - BAR chart
    # Shows relationship between assurance level and vulnerability exposure
    avg_cve_by_eal_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-avg-cve-by-eal",
        title="Average CVEs per Certificate by EAL Level",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="heuristics.eal", label="EAL Level"),
        y_axis=AxisConfig(field="cve_count", label="Avg CVEs per Certificate", aggregation=AggregationType.AVG),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(avg_cve_by_eal_config))

    # Transitive CVE Exposure by Category - BAR chart
    # Shows supply chain risk: CVEs inherited through dependencies
    transitive_by_category_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-transitive-cve-by-category",
        title="Transitive CVE Exposure by Category",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="category", label="Category"),
        y_axis=AxisConfig(
            field="total_transitive_cve_count",
            label="Total Transitive CVEs",
            aggregation=AggregationType.SUM,
            log_scale=True,
        ),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(transitive_by_category_config))

    # CVE Exposure by Scheme - BAR chart
    # Shows which certification schemes have products with most vulnerabilities
    cve_by_scheme_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-cve-by-scheme",
        title="Total CVEs by Certification Scheme",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="scheme", label="Scheme"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(cve_by_scheme_config))

    return charts


def create_fips_vulnerability_charts() -> list:
    """Create FIPS vulnerability charts using the standard derived fields system."""
    charts = []

    # Total CVE Count by Security Level - BAR chart
    # Shows vulnerability exposure across FIPS security levels (1-4)
    cve_by_level_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-cve-count-by-level",
        title="Total CVEs by Security Level",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.level", label="Security Level"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM, log_scale=True),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(cve_by_level_config))

    # Average CVE Count by Security Level - BAR chart
    # Normalized view: do higher security levels have fewer CVEs per module?
    avg_cve_by_level_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-avg-cve-by-level",
        title="Average CVEs per Module by Security Level",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.level", label="Security Level"),
        y_axis=AxisConfig(
            field="cve_count", label="Avg CVEs per Module", aggregation=AggregationType.AVG, log_scale=True
        ),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(avg_cve_by_level_config))

    # Total CVE Count by Module Type - BAR chart
    # Shows which module types (Hardware, Software, Firmware) have more vulnerabilities
    cve_by_module_type_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-cve-by-module-type",
        title="Total CVEs by Module Type",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.module_type", label="Module Type"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM, log_scale=True),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(cve_by_module_type_config))

    # Average CVE Count by FIPS Standard - BAR chart
    # Compares vulnerability rates across FIPS 140-1, 140-2, 140-3
    avg_cve_by_standard_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-avg-cve-by-standard",
        title="Average CVEs per Module by FIPS Standard",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.standard", label="FIPS Standard"),
        y_axis=AxisConfig(field="cve_count", label="Avg CVEs per Module", aggregation=AggregationType.AVG),
        show_legend=False,
        show_grid=True,
        show_zero_values=False,
    )
    charts.append(ChartFactory.create_chart(avg_cve_by_standard_config))

    return charts
