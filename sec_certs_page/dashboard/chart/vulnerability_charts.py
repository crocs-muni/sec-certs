"""Vulnerability analysis chart definitions.

This module provides predefined charts for vulnerability exposure and supply chain
risk analysis.

There are two types of charts here:
1. PipelineChart - uses custom MongoDB aggregation pipelines for complex queries
   that can't be expressed through the standard axis configuration
2. Standard ChartConfig - uses the derived fields (cve_count, etc.) that work
   with the standard build_chart_pipeline system

Charts included:
- CC certificates with CVEs (by category, by vendor)
- FIPS certificates with CVEs
- Transitive vulnerability analysis
- CVE distribution by category
"""

from typing import Any
from uuid import uuid4

from ..types.chart import ChartType
from ..types.common import CollectionName
from ..types.filter import AggregationType
from .chart import PipelineChart
from .config import AxisConfig, ChartConfig
from .factory import ChartFactory


def _build_cc_cve_by_category_pipeline(filter_values: dict[str, Any] | None) -> list[dict[str, Any]]:
    """Build pipeline for CC CVE distribution by category."""
    pipeline: list[dict[str, Any]] = []

    # Base match for certificates with category
    match_stage: dict[str, Any] = {"category": {"$ne": None}}

    # Apply status filter if provided
    if filter_values and "cc-status-filter" in filter_values:
        status = filter_values["cc-status-filter"]
        if status and status != "__all__":
            if isinstance(status, list):
                match_stage["status"] = {"$in": status}
            else:
                match_stage["status"] = status

    pipeline.append({"$match": match_stage})

    # Group by category and aggregate CVE counts
    pipeline.append(
        {
            "$group": {
                "_id": "$category",
                "total_certificates": {"$sum": 1},
                "certificates_with_cves": {
                    "$sum": {
                        "$cond": [{"$gt": [{"$size": {"$ifNull": ["$heuristics.related_cves._value", []]}}, 0]}, 1, 0]
                    }
                },
                "total_cves": {"$sum": {"$size": {"$ifNull": ["$heuristics.related_cves._value", []]}}},
            }
        }
    )

    # Project to expected field names (matching axis config)
    pipeline.append(
        {
            "$project": {
                "_id": 0,
                "category": "$_id",
                "CVE Count": "$total_cves",
            }
        }
    )

    pipeline.append({"$sort": {"CVE Count": -1}})

    return pipeline


def _build_cc_cve_by_vendor_pipeline(filter_values: dict[str, Any] | None) -> list[dict[str, Any]]:
    """Build pipeline for CC vulnerability density by vendor."""
    pipeline: list[dict[str, Any]] = []

    # Base match for certificates with manufacturer and CVEs
    match_stage: dict[str, Any] = {
        "manufacturer": {"$ne": None},
        "heuristics.related_cves._value": {"$exists": True},
    }

    # Apply status filter if provided
    if filter_values and "cc-status-filter" in filter_values:
        status = filter_values["cc-status-filter"]
        if status and status != "__all__":
            if isinstance(status, list):
                match_stage["status"] = {"$in": status}
            else:
                match_stage["status"] = status

    pipeline.append({"$match": match_stage})

    # Group by vendor
    pipeline.append(
        {
            "$group": {
                "_id": "$manufacturer",
                "total_certificates": {"$sum": 1},
                "certificates_with_cves": {
                    "$sum": {
                        "$cond": [{"$gt": [{"$size": {"$ifNull": ["$heuristics.related_cves._value", []]}}, 0]}, 1, 0]
                    }
                },
                "total_cves": {"$sum": {"$size": {"$ifNull": ["$heuristics.related_cves._value", []]}}},
            }
        }
    )

    # Project and calculate vulnerability rate
    pipeline.append(
        {
            "$project": {
                "_id": 0,
                "manufacturer": "$_id",
                "CVE Count": "$total_cves",
            }
        }
    )

    pipeline.append({"$sort": {"CVE Count": -1}})
    pipeline.append({"$limit": 20})  # Top 20 vendors

    return pipeline


def _build_cc_transitive_cve_pipeline(filter_values: dict[str, Any] | None) -> list[dict[str, Any]]:
    """Build pipeline for CC transitive vulnerability analysis."""
    pipeline: list[dict[str, Any]] = []

    # Match certificates with transitive CVEs
    match_stage: dict[str, Any] = {
        "$or": [
            {"heuristics.direct_transitive_cves._value.0": {"$exists": True}},
            {"heuristics.indirect_transitive_cves._value.0": {"$exists": True}},
        ]
    }

    pipeline.append({"$match": match_stage})

    # Project CVE counts
    pipeline.append(
        {
            "$project": {
                "_id": 0,
                "category": 1,
                "direct": {"$size": {"$ifNull": ["$heuristics.related_cves._value", []]}},
                "direct_trans": {"$size": {"$ifNull": ["$heuristics.direct_transitive_cves._value", []]}},
                "indirect_trans": {"$size": {"$ifNull": ["$heuristics.indirect_transitive_cves._value", []]}},
            }
        }
    )

    # Group by category to show distribution
    pipeline.append(
        {
            "$group": {
                "_id": "$category",
                "total_direct_transitive": {"$sum": "$direct_trans"},
                "total_indirect_transitive": {"$sum": "$indirect_trans"},
                "certificate_count": {"$sum": 1},
            }
        }
    )

    pipeline.append(
        {
            "$project": {
                "_id": 0,
                "category": "$_id",
                "Transitive CVEs": {"$add": ["$total_direct_transitive", "$total_indirect_transitive"]},
            }
        }
    )

    pipeline.append({"$sort": {"Transitive CVEs": -1}})

    return pipeline


def _build_fips_cve_by_vendor_pipeline(filter_values: dict[str, Any] | None) -> list[dict[str, Any]]:
    """Build pipeline for FIPS CVE distribution by vendor."""
    pipeline: list[dict[str, Any]] = []

    # Base match for certificates with vendor and CVEs
    match_stage: dict[str, Any] = {
        "web_data.vendor": {"$ne": None},
        "heuristics.related_cves._value": {"$exists": True},
    }

    # Apply status filter if provided
    if filter_values and "fips-status-filter" in filter_values:
        status = filter_values["fips-status-filter"]
        if status and status != "__all__":
            if isinstance(status, list):
                match_stage["web_data.status"] = {"$in": status}
            else:
                match_stage["web_data.status"] = status

    pipeline.append({"$match": match_stage})

    # Group by vendor
    pipeline.append(
        {
            "$group": {
                "_id": "$web_data.vendor",
                "total_certificates": {"$sum": 1},
                "certificates_with_cves": {
                    "$sum": {
                        "$cond": [{"$gt": [{"$size": {"$ifNull": ["$heuristics.related_cves._value", []]}}, 0]}, 1, 0]
                    }
                },
                "total_cves": {"$sum": {"$size": {"$ifNull": ["$heuristics.related_cves._value", []]}}},
            }
        }
    )

    pipeline.append(
        {
            "$project": {
                "_id": 0,
                "web_data_vendor": "$_id",
                "CVE Count": "$total_cves",
            }
        }
    )

    pipeline.append({"$sort": {"CVE Count": -1}})
    pipeline.append({"$limit": 20})

    return pipeline


def _build_fips_cve_by_level_pipeline(filter_values: dict[str, Any] | None) -> list[dict[str, Any]]:
    """Build pipeline for FIPS CVE distribution by security level."""
    pipeline: list[dict[str, Any]] = []

    # Match certificates with level and CVEs
    match_stage: dict[str, Any] = {
        "web_data.level": {"$ne": None},
        "heuristics.related_cves._value.0": {"$exists": True},
    }

    pipeline.append({"$match": match_stage})

    # Group by security level
    pipeline.append(
        {
            "$group": {
                "_id": "$web_data.level",
                "total_certificates": {"$sum": 1},
                "total_cves": {"$sum": {"$size": {"$ifNull": ["$heuristics.related_cves._value", []]}}},
            }
        }
    )

    pipeline.append(
        {
            "$project": {
                "_id": 0,
                "web_data_level": {"$toString": "$_id"},
                "CVE Count": "$total_cves",
            }
        }
    )

    pipeline.append({"$sort": {"web_data_level": 1}})

    return pipeline


def create_cc_vulnerability_charts() -> list[PipelineChart]:
    """Create predefined CC vulnerability analysis charts."""
    charts = []

    # Chart 1: CVE Distribution by Category
    cve_by_category_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-cve-by-category",
        title="CVE Distribution by Product Category",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="category", label="Category"),
        y_axis=AxisConfig(field="CVE Count", label="CVE Count", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
    )
    charts.append(PipelineChart(config=cve_by_category_config, pipeline_builder=_build_cc_cve_by_category_pipeline))

    # Chart 2: Top Vendors by CVE Count
    cve_by_vendor_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-cve-by-vendor",
        title="Top 20 Vendors by CVE Count",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="manufacturer", label="Vendor"),
        y_axis=AxisConfig(field="CVE Count", label="CVE Count", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
    )
    charts.append(PipelineChart(config=cve_by_vendor_config, pipeline_builder=_build_cc_cve_by_vendor_pipeline))

    # Chart 3: Transitive Vulnerability Distribution
    transitive_cve_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-transitive-cve",
        title="Transitive CVE Exposure by Category",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="category", label="Category"),
        y_axis=AxisConfig(field="Transitive CVEs", label="Transitive CVEs", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
    )
    charts.append(PipelineChart(config=transitive_cve_config, pipeline_builder=_build_cc_transitive_cve_pipeline))

    return charts


def create_fips_vulnerability_charts() -> list[PipelineChart]:
    """Create predefined FIPS vulnerability analysis charts."""
    charts = []

    # Chart 1: CVE Distribution by Vendor
    cve_by_vendor_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-cve-by-vendor",
        title="Top 20 Vendors by CVE Count",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.vendor", label="Vendor"),
        y_axis=AxisConfig(field="CVE Count", label="CVE Count", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
    )
    charts.append(PipelineChart(config=cve_by_vendor_config, pipeline_builder=_build_fips_cve_by_vendor_pipeline))

    # Chart 2: CVE Distribution by Security Level
    cve_by_level_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-cve-by-level",
        title="CVE Distribution by Security Level",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.level", label="Security Level"),
        y_axis=AxisConfig(field="CVE Count", label="CVE Count", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
    )
    charts.append(PipelineChart(config=cve_by_level_config, pipeline_builder=_build_fips_cve_by_level_pipeline))

    return charts


# =============================================================================
# Standard charts using derived fields (work with standard build_chart_pipeline)
# These can be created by users through the UI or used as predefined charts.
# =============================================================================


def create_cc_standard_vulnerability_charts() -> list:
    """Create CC vulnerability charts using the standard derived fields system.

    These charts use cve_count, direct_transitive_cve_count, etc. derived fields
    which work with the standard build_chart_pipeline function.
    """
    charts = []

    # CVE Count by Category (standard)
    cve_by_category_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-cve-count-by-category",
        title="CVE Count by Category",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="category", label="Category"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
    )
    charts.append(ChartFactory.create_chart(cve_by_category_config))

    # CVE Count by Vendor (standard)
    cve_by_vendor_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-cve-count-by-vendor",
        title="CVE Count by Vendor",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="manufacturer", label="Vendor"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
    )
    charts.append(ChartFactory.create_chart(cve_by_vendor_config))

    # Transitive CVE Count by Category
    transitive_by_category_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-transitive-cve-by-category",
        title="Transitive CVE Exposure by Category",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="category", label="Category"),
        y_axis=AxisConfig(
            field="total_transitive_cve_count", label="Transitive CVEs", aggregation=AggregationType.SUM
        ),
        show_legend=False,
        show_grid=True,
    )
    charts.append(ChartFactory.create_chart(transitive_by_category_config))

    # Average CVE Count by EAL Level
    avg_cve_by_eal_config = ChartConfig(
        chart_id=uuid4(),
        name="cc-avg-cve-by-eal",
        title="Average CVE Count by EAL Level",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.CommonCriteria,
        x_axis=AxisConfig(field="heuristics.eal", label="EAL Level"),
        y_axis=AxisConfig(field="cve_count", label="Avg CVEs per Certificate", aggregation=AggregationType.AVG),
        show_legend=False,
        show_grid=True,
    )
    charts.append(ChartFactory.create_chart(avg_cve_by_eal_config))

    return charts


def create_fips_standard_vulnerability_charts() -> list:
    """Create FIPS vulnerability charts using the standard derived fields system."""
    charts = []

    # CVE Count by Security Level
    cve_by_level_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-cve-count-by-level",
        title="CVE Count by Security Level",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.level", label="Security Level"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
    )
    charts.append(ChartFactory.create_chart(cve_by_level_config))

    # CVE Count by Vendor
    cve_by_vendor_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-cve-count-by-vendor",
        title="CVE Count by Vendor",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.vendor", label="Vendor"),
        y_axis=AxisConfig(field="cve_count", label="Total CVEs", aggregation=AggregationType.SUM),
        show_legend=False,
        show_grid=True,
    )
    charts.append(ChartFactory.create_chart(cve_by_vendor_config))

    # Average CVE Count by Standard (FIPS 140-1, 140-2, 140-3)
    avg_cve_by_standard_config = ChartConfig(
        chart_id=uuid4(),
        name="fips-avg-cve-by-standard",
        title="Average CVE Count by FIPS Standard",
        chart_type=ChartType.BAR,
        collection_name=CollectionName.FIPS140,
        x_axis=AxisConfig(field="web_data.standard", label="FIPS Standard"),
        y_axis=AxisConfig(field="cve_count", label="Avg CVEs per Module", aggregation=AggregationType.AVG),
        show_legend=False,
        show_grid=True,
    )
    charts.append(ChartFactory.create_chart(avg_cve_by_standard_config))

    return charts
