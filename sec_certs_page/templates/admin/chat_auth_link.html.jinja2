{% extends "admin/base.html.jinja2" %}
{% block title %}Create chat invite link{% endblock %}

{% block content %}
<h1>Create chat invite link</h1>
<div id="chat-auth-link-form">
  <form id="auth-link-form">
    <div>
      <label for="link_duration">Link validity (seconds, 60-604800):</label>
      <input type="number" id="link_duration" name="link_duration" min="60" max="604800" value="600" required>
    </div>
    <div>
      <label for="chat_duration">Chat session duration (seconds, 60-604800):</label>
      <input type="number" id="chat_duration" name="chat_duration" min="60" max="604800" value="600" required>
    </div>
    <button type="submit">Generate link</button>
  </form>
  <div id="auth-link-result" style="margin-top:1em;"></div>
</div>

<script>
document.getElementById('auth-link-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const link_duration = document.getElementById('link_duration').value;
  const chat_duration = document.getElementById('chat_duration').value;
  const resultDiv = document.getElementById('auth-link-result');
  resultDiv.textContent = 'Generating...';
  try {
    const resp = await fetch('/chat/auth-link/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ link_duration, chat_duration })
    });
    const data = await resp.json();
    if (data.status === 'ok') {
      resultDiv.innerHTML = `<b>Invite Link:</b> <a href="${data.link}" target="_blank">${data.link}</a><br>
        <b>Link Valid For:</b> ${data.link_expires_in} seconds<br>
        <b>Chat Session Duration:</b> ${data.chat_expires_in} seconds`;
    } else {
      resultDiv.textContent = data.message || 'Error generating link.';
    }
  } catch (err) {
    resultDiv.textContent = 'Network or server error.';
  }
});
</script>
{% endblock %}
