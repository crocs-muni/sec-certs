{% macro render_local_file(hashid, link_content, link, local_files, document, primary_style, secondary_style) %}
    <div class="btn-group">
        {% if link %}
            <a class="btn {{ primary_style }}" role="button" href="{{ link }}"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="{{ link.split("/")[-1] if "/" in link else link }}" target="_blank"
               rel="noopener">{{ link_content|safe }}</a>
        {% endif %}
        {% for format in ("pdf", "txt") %}
            {% if local_files.get((document, format)) %}
                <a class="btn {{ secondary_style }}" role="button"
                   href="{{ url_for(".entry_" + document + "_" + format, hashid=hashid) }}"
                   data-bs-toggle="tooltip" data-bs-placement="bottom"
                   title="Local download" target="_blank">{{ format.upper() }}</a>
            {% endif %}
        {% endfor %}
    </div>
{% endmacro %}

{% macro render_local_cert(hashid, local_files, cert_link, primary_style="btn-outline-primary", secondary_style="btn-outline-secondary") %}
    {{ render_local_file(hashid, '<i class="fas fa-file-contract"></i> Certificate', cert_link, local_files, "cert", primary_style, secondary_style) }}
{% endmacro %}

{% macro render_local_report(hashid, local_files, report_link, primary_style="btn-outline-primary", secondary_style="btn-outline-secondary") %}
    {{ render_local_file(hashid, '<i class="fas fa-file-contract"></i> Certification report', report_link, local_files, "report", primary_style, secondary_style) }}
{% endmacro %}

{% macro render_local_target(hashid, local_files, target_link, primary_style="btn-outline-primary", secondary_style="btn-outline-secondary") %}
    {{ render_local_file(hashid, '<i class="fas fa-file-alt"></i> Security target', target_link, local_files, "target", primary_style, secondary_style) }}
{% endmacro %}

{% macro render_local_profile(hashid, local_files, profile_link, primary_style="btn-outline-primary", secondary_style="btn-outline-secondary") %}
    {{ render_local_file(hashid, '<i class="fas fa-file-alt"></i> Protection profile', profile_link, local_files, "profile", primary_style, secondary_style) }}
{% endmacro %}

{% macro opt_line(name, key, obj, title) %}
    {% if key in obj and obj[key] %}
        <tr data-cs-name="{{ title }} - {{ name }}">
            <th scope="row">{{ name }}</th>
            <td>{{ obj[key] }}</td>
        </tr>
    {% endif %}
{%- endmacro %}

{% macro render_pdf_meta(pdf_meta, title) %}
    <table class="w-100">
        <colgroup>
            <col style="width:20%">
            <col style="width:80%">
        </colgroup>
        <tbody>
        {{ opt_line("Title", "/Title", pdf_meta, title) }}
        {{ opt_line("Subject", "/Subject", pdf_meta, title) }}
        {{ opt_line("Keywords", "/Keywords", pdf_meta, title) }}
        {{ opt_line("Author", "/Author", pdf_meta, title) }}
        {{ opt_line("Creation date", "/CreationDate", pdf_meta, title) }}
        {{ opt_line("Modification date", "/ModDate", pdf_meta, title) }}
        {{ opt_line("Pages", "pdf_number_of_pages", pdf_meta, title) }}
        {{ opt_line("Creator", "/Creator", pdf_meta, title) }}
        {{ opt_line("Producer", "/Producer", pdf_meta, title) }}
        </tbody>
    </table>
{%- endmacro %}

{% macro render_cve_impact(cve) %}
    {% if cve["impact"]["severity"] == "CRITICAL" %}
        <span style="color: var(--bs-red)"><i class="fas fa-fw fa-exclamation-triangle"></i></span>
        CRITICAL
    {% elif cve["impact"]["severity"] == "HIGH" %}
        <span style="color: var(--bs-orange)"><i class="fas fa-fw fa-exclamation-circle"></i></span>
        HIGH
    {% elif cve["impact"]["severity"] == "MEDIUM" %}
        <span style="color: var(--bs-yellow)"><i class="fas fa-fw fa-exclamation"></i></span> MEDIUM
    {% elif cve["impact"]["severity"] == "LOW" %}
        <span style="color: var(--bs-green)"><i class="fas fa-fw fa-exclamation"></i></span> LOW
    {% else %}
        {{ cve["impact"]["severity"] }}
    {% endif %}
{% endmacro %}

{% macro render_cve_links(cve, full=False) %}
    <div class="btn-group" role="group" aria-label="CVE links">
        <a href="https://www.cve.org/CVERecord?id={{ cve["cve_id"] }}"
           target="_blank" rel="noopener" title="CVE at cve.org"
           class="btn btn-outline-secondary btn-sm">{% if full %}cve.org{% else %}C{% endif %}</a>
        <a href="https://nvd.nist.gov/vuln/detail/{{ cve["cve_id"] }}" target="_blank"
           rel="noopener" title="CVE in NIST's Vulnerability Database"
           class="btn btn-outline-secondary btn-sm">{% if full %}nvd.nist.gov{% else %}N{% endif %}</a>
    </div>
{% endmacro %}

{% macro render_cves(cves) %}
    <div class="my-1">
        <table class="table table-striped">
            <colgroup>
                <col style="width:15%">
                <col style="width:10%">
                <col style="width:20%">
                <col style="width:10%">
                <col style="width:10%">
                <col style="width:10%">
                <col style="width:15%">
            </colgroup>
            <thead>
            <tr>
                <th scope="col" colspan="1" rowspan="2">ID</th>
                <th scope="col" colspan="1" rowspan="2">Links</th>
                <th scope="col" colspan="1" rowspan="2">Severity</th>
                <th scope="col" colspan="3" class="text-center pb-0">CVSS Score</th>
                <th scope="col" colspan="1" rowspan="2">Published on</th>
            </tr>
            <tr>
                <th scope="col">Base</th>
                <th scope="col">Exploitability</th>
                <th scope="col">Impact</th>
            </tr>
            </thead>
            <tbody>
            {% set years = namespace(cve=None, current=None) %}
            {% for cve in cves %}
                {% set years.current = cve["cve_id"].split("-")[1] %}
                <tr {% if years.current != years.cve and years.cve %}
                    style="border-top: 2px solid var(--bs-dark)"{% endif %}
                        {% if cves|length > 5 and loop.index0 >= 5 %}
                    class="collapse cve-collapse" {% endif %}>
                    <td><a href="{{ url_for("vuln.cve", cve_id=cve["cve_id"]) }}">{{ cve["cve_id"] }}</a></td>
                    <td>
                        {{ render_cve_links(cve) }}
                    </td>
                    <td>
                        {{ render_cve_impact(cve) }}
                    </td>
                    <td>{{ cve["impact"]["base_score"] }}</td>
                    <td>{{ cve["impact"]["explotability_score"] }}</td>
                    <td>{{ cve["impact"]["impact_score"] }}</td>
                    <td>{{ cve["published_date"]|fromisoformat()|strftime("%d.%m.%Y") }}</td>

                </tr>
                {% set years.cve = years.current %}
            {% endfor %}
            </tbody>
        </table>
        {% if cves|length > 5 %}
            <div id="cve-toggle" class="d-flex justify-content-center">
                <div class="d-inline-flex flex-column">
                    <span class="text-muted">Showing 5 out of {{ cves|length }}.</span>
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse"
                            data-bs-target=".cve-collapse" aria-expanded="false"
                            aria-controls=".cve-collapse"
                            onclick="$('#cve-toggle').toggleClass('d-flex').hide()">Show all
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
{%- endmacro %}

{% macro render_references(network, hashid, type, status_func=None) %}
    {% if network and hashid in network.nodes %}
        {% set refs = namespace(outgoing=False, incoming=False) %}
        {% set out_edges = network.out_edges(hashid) %}
        {% set in_edges = network.in_edges(hashid) %}
        {% for edge in out_edges %}
            {% if type in network.edges[edge]["type"] %}
                {% set refs.outgoing = True %}
            {% endif %}
        {% endfor %}
        {% for edge in in_edges %}
            {% if type in network.edges[edge]["type"] %}
                {% set refs.incoming = True %}
            {% endif %}
        {% endfor %}

        {% if refs.incoming or refs.outgoing %}
            <h3 class="mt-3">References</h3>
            {% if refs.outgoing %}
                <b>Outgoing</b>
                <ul class="outgoing-list">
                    {% for edge in out_edges %}
                        {% set child_node = network.nodes[edge[1]] %}
                        {% if type in network.edges[edge]["type"] %}
                            <li>
                                <a href="{{ child_node["href"] }}">{{ child_node["certid"] }}</a>
                                {% if status_func is not none %}
                                    - {{ status_func(child_node["status"]) }}
                                {% endif %}
                                - {{ child_node["name"] }}
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            {% endif %}
            {% if refs.incoming %}
                <b>Incoming</b>
                <ul class="incoming-list">
                    {% for edge in in_edges %}
                        {% set parent_node = network.nodes[edge[0]] %}
                        {% if type in network.edges[edge]["type"] %}
                            <li>
                                <a href="{{ parent_node["href"] }}">{{ parent_node["certid"] }}</a>
                                {% if status_func is not none %}
                                    - {{ status_func(parent_node["status"]) }}
                                {% endif %}
                                - {{ parent_node["name"] }}
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            {% endif %}
        {% endif %}
    {% endif %}
{%- endmacro %}

{% macro keywords_card(keyword_scan, doc_prefix, card_id, card_name, keyword_sources, hidden, map_funcs) %}
    {% set ns = namespace(render=False) %}
    {% for heading, keyword in keyword_sources.items() %}
        {% if keyword not in hidden and keyword_scan[keyword] %}
            {% set ns.render = True %}
        {% endif %}
    {% endfor %}
    {% if ns.render %}
        <div class="card mt-1">
            <div class="card-header" id="{{ doc_prefix }}-{{ card_id }}-head">
                <h4 class="mb-0">
                    <button class="btn btn-link w-100 text-start" data-bs-toggle="collapse"
                            data-bs-target="#{{ doc_prefix }}-{{ card_id }}-card" aria-expanded="false"
                            aria-controls="{{ doc_prefix }}-{{ card_id }}-card">
                        {{ card_name }}
                        <i class="fas fa-chevron-down"></i>
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </h4>
            </div>

            <div id="{{ doc_prefix }}-{{ card_id }}-card" class="collapse"
                 aria-labelledby="{{ doc_prefix }}-{{ card_id }}-head">
                <div class="card-body">
                    {% for heading, keyword in keyword_sources.items() %}
                        {% if keyword not in hidden and keyword_scan[keyword] %}
                            <div data-cs-name="{{ doc_prefix }} - {{ card_name }} - {{ heading }}">
                                <h5 class="mt-2">{{ heading }}</h5>
                                {{ double_join(keyword_scan[keyword], map_func=map_funcs.get(keyword, None)) }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
{% endmacro %}

{% macro double_join(rule_dict, separator=", ", map_func=None) %}
    {% for key in flatten(rule_dict).keys() %}
        {%- if map_func -%}{{ map_func(key) }}{%- else -%}{{ key }}{%- endif -%}
        {%- if not loop.last -%}{{ separator }}{%- endif -%}
    {% endfor %}
{%- endmacro %}


{% macro cryptography_keywords(keyword_scan, doc_prefix, hidden=[], map_funcs={}) -%}
    {{ keywords_card(keyword_scan, doc_prefix, "crypto", "Cryptography", {"Symmetric Algorithms": "symmetric_crypto",
                                                                          "Asymmetric Algorithms": "asymmetric_crypto",
                                                                          "Post-quantum Algorithms": "pq_crypto",
                                                                          "Hash functions": "hash_function",
                                                                          "Schemes": "crypto_scheme",
                                                                          "Protocols": "crypto_protocol",
                                                                          "Randomness": "randomness",
																		  "Engines": "crypto_engine",
																		  "Libraries": "crypto_library",
																		  "Elliptic Curves": "ecc_curve",
																		  "Block cipher modes": "cipher_mode",
																		  "TLS cipher suites": "tls_cipher_suite"}, hidden, map_funcs) }}
{%- endmacro %}

{% macro device_keywords(keyword_scan, doc_prefix, hidden=[], map_funcs={}) -%}
    {{ keywords_card(keyword_scan, doc_prefix, "device", "Device", {"Device models": "device_model",
																	"JavaCard versions": "javacard_version",
																	"JavaCard API constants": "javacard_api_const",
																	"JavaCard packages": "javacard_package",
																	"Operating System name": "os_name",
																	"CPLC": "cplc_data",
																	"IC data groups": "ic_data_group",
																	"Trusted Execution Environments": "tee_name",
																	"Vendor": "vendor"}, hidden, map_funcs) }}
{%- endmacro %}

{% macro security_keywords(keyword_scan, doc_prefix, hidden=[], map_funcs={}) -%}
    {{ keywords_card(keyword_scan, doc_prefix, "security", "Security", {"Side-channel analysis": "side_channel_analysis",
																		"Vulnerabilities": "vulnerability",
																		"Certification process": "certification_process"}, hidden, map_funcs) }}
{%- endmacro %}

{% macro other_keywords(keyword_scan, doc_prefix, hidden=[], map_funcs={}) -%}
    {{ keywords_card(keyword_scan, doc_prefix, "other", "Other", {"Standards": "standard_id",
																  "Technical reports": "technical_report_id"}, hidden, map_funcs) }}
{%- endmacro %}

{% macro render_updates(doc_name, diffs, diff_jsons, diff_renders) %}
    <ul class="list-unstyled" role="list" aria-label="Change history">
        {% for diff, json_diff, diff_render in zip(diffs, diff_jsons, diff_renders) %}
            {# Use the db id to generate stable unique IDs for collapse panels #}
            {% set panel_id = "diff-data-" ~ diff["_id"] %}
            <li class="my-3" id="diff-{{ diff['_id'] }}">
                <div class="row g-2 align-items-start">
                    <div class="col-12 col-md-2">
                        <time datetime="{{ diff['timestamp']|strftime('%Y-%m-%d') }}"
                              title="{{ diff['timestamp']|strftime('%d.%m.%Y') }}"
                              class="fw-bold d-block">
                            {{ diff["timestamp"] | strftime("%d.%m.%Y") }}
                        </time>
                    </div>

                    <div class="col-12 col-md-8">
                        <div class="d-flex align-items-start gap-2">
                            {% if diff["type"] == "new" %}
                                <span class="badge bg-success" aria-hidden="true">New</span>
                                <div>The {{ doc_name }} was first processed.</div>
                            {% elif diff["type"] == "change" %}
                                <span class="badge bg-primary" aria-hidden="true">Changed</span>
                                <div>The {{ doc_name }} data changed.</div>
                            {% elif diff["type"] == "remove" %}
                                <span class="badge bg-warning text-dark"
                                      aria-hidden="true">Unavailable</span>
                                <div>The {{ doc_name }} became unavailable â€” it disappeared from the
                                    upstream listing.
                                </div>
                            {% elif diff["type"] == "back" %}
                                <span class="badge bg-info text-dark" aria-hidden="true">Back</span>
                                <div>The {{ doc_name }} became available again.</div>
                            {% else %}
                                <div>The {{ doc_name }} was updated.</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-12 col-md-2 d-flex justify-content-md-end align-items-start">
                        <button type="button"
                                class="btn btn-outline-primary btn-sm toggle-diff"
                                aria-controls="{{ panel_id }}"
                                aria-expanded="false"
                                data-bs-toggle="collapse"
                                data-bs-target="#{{ panel_id }}"
                                title="Show changes">
                            <i class="fas fa-fw fa-plus" aria-hidden="true"></i>
                            <span class="ms-1">Show diff</span>
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div id="{{ panel_id }}" class="collapse mt-2" aria-hidden="true">
                        {{ diff_render|safe }}
                    </div>
                </div>
            </li>
        {% endfor %}
    </ul>
{%- endmacro %}