{% extends "common/base.html.jinja2" %}
{% set crumbs = True %}
{% set search = True %}

{% if searchType == "fulltext" %}
    {% from "cc/utils.html.jinja2" import render_status, render_category, render_document_type %}
{% elif searchType == "byName" %}
    {% from "cc/utils.html.jinja2" import render_pagination, render_plot %}
{% endif %}

{% block content %}
    <main>
        <div class="col-12 col-sm-10 mx-auto p-3 py-md-5">
            <div class="alert alert-warning d-sm-none" role="alert">
                <i class="fas fa-exclamation-triangle"></i> This page was not yet optimized for use on mobile devices.
            </div>
            <h1>Common Criteria</h1>
            <h3 class="text-secondary">Search</h3>
            <div class="card mt-3 mt-4 mb-4">
                <div class="card-body container">
                    <div id="name" class="mt-1 mb-3">
                        <h4><label for="search">Name</label></h4>
                        <div class="form-inline">
                            <input id="search" class="form-control mb-2" placeholder="Search" type="search"
                                   value="{{ q|default('', true) }}"/>
                            
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="searchTypeRadio" id="nameSearchRadioId" value="byName" checked>
                                <label class="form-check-label" for="nameSearchRadioId">Name search</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="searchTypeRadio" id="fulltextSearchRadioId" value="fulltext">
                                <label class="form-check-label" for="fulltextSearchRadioId">Fulltext search</label>
                            </div>
                            <div class="mt-2">
                                <button type="button" id="search-btn" class="btn btn-primary"><i class="fas fa-search"></i>
                                    Search
                                </button>
                                <button type="button" id="network-btn" class="btn btn-primary"
                                        title="Display the references network of the resulting certificates."
                                        data-bs-toggle="tooltip">Display network
                                </button>
                                <button id="extended-btn" class="btn btn-outline-primary" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#extended"
                                        aria-controls="extended"
                                        aria-expanded="{% if advanced %}true{% else %}false{% endif %}"><i
                                        class="fas fa-sliders"></i> Advanced options
                                </button>
                            </div>
                            
                        </div>
                        <small class="text-muted">Search by certificate name (case-insensitive). Uses
                            <a href="https://www.mongodb.com/docs/manual/reference/operator/query/text/#std-label-text-operator-phrases"
                               target="_blank" rel="noopener">MongoDB $text search</a>, use quotes to specify a phrase
                            and a hyphen-minus prefix to negate a match.</small><br/>
                        <small class="text-muted">E.g. <span class="font-monospace border rounded" onclick="window.getSelection().selectAllChildren(this)">Infineon Security Controller</span>.</small>
                    </div>
                    <div id="extended" class="collapse {% if advanced %}show{% endif %} mt-3">
                        <div id="categories" class="mb-3">
                            <h4>Categories
                                <button id="cat-select-all" class="btn btn-outline-primary">Select all</button>
                                <button id="cat-deselect-all" class="btn btn-outline-primary">Deselect all</button>
                            </h4>

                            <div id="search-categories" class="row">
                                {% for name, val in categories.items() %}
                                    {% if loop.index0 % 5 == 0 %}
                                        <div class="col">
                                    {% endif %}
                                <div class="form-check">
                                    <span>
                                        <input id="category-{{ val['id'] }}" type="checkbox" class="form-check-input"
                                               data-id="{{ val['id'] }}" {% if val["selected"] %}checked{% endif %}>
                                        <label class="form-check-label" for="category-{{ val['id'] }}">
                                            <i class="fas fa-fw {{ val['icon'] }}"></i> {{ name }}
                                        </label>
                                    </span>
                                </div>
                                {% if (loop.index0 + 1) % 5 == 0 %}
                                    </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <table class="table w-auto align-middle">
                            <tbody>
                                <tr>
                                    <td>
                                        <h6 class="d-inline"><label for="search-status">Status: </label></h4>
                                    </td>
                                    <td>
                                        <select id="search-status" class="d-inline form-control">
                                            <option value="any" {% if status == "any" %}selected="selected"{% endif %}>Any</option>
                                            <option value="active" class="text-success"
                                                    {% if status == "active" %}selected="selected"{% endif %}>Active
                                            </option>
                                            <option value="archived" class="text-warning"
                                                    {% if status == "archived" %}selected="selected"{% endif %}>Archived
                                            </option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <h6 class="d-inline"><label for="search-scheme">Scheme: </label></h4>
                                    </td>
                                    <td>
                                        <select id="search-scheme" class="form-control">
                                            <option value="any" {% if scheme == "any" %}selected="selected"{% endif %}>Any
                                            </option>
                                            {% for s in schemes|sort %}
                                                <option value="{{ s }}" {% if scheme == s %}selected="selected"{% endif %}>{{ country_to_flag(s) }} {{ s }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="mt-5 mb-3">
                            <h4>Search type specific</h4>
                            <table class="table w-auto align-middle">
                                <tbody>
                                    <tr>
                                        <td>
                                            <h6 class="d-inline"><label for="search-sort">Sort:</label></h6>
                                        </td>
                                        <td>
                                            <span id="search-sort-tooltip" data-bs-toggle="tooltip" data-bs-placement="top" title="This option is enabled only in name search">
                                            <select id="search-sort" class="form-control">
                                                <option value="match" {% if sort == "match" %}selected="selected"{% endif %}>Match
                                                </option>
                                                <option value="name" {% if sort == "name" %}selected="selected"{% endif %}>Name</option>
                                                <option value="cert_date" {% if sort == "cert_date" %}selected="selected"{% endif %}>
                                                    Certification date
                                                </option>
                                                <option value="archive_date"
                                                        {% if sort == "archive_date" %}selected="selected"{% endif %}>
                                                    Archive date
                                                </option>
                                            </select>
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <h6 class="d-inline"><label for="search-type">Document type:</label></h6>
                                        </td>
                                        <td>
                                            <span id="search-type-tooltip" data-bs-toggle="tooltip" data-bs-placement="top" title="This option is enabled only in fulltext search">
                                            <select id="search-type" class="form-control">
                                                <option value="any" {% if document_type == "any" %}selected="selected"{% endif %}>Any
                                                </option>
                                                <option value="cert" {% if document_type == "cert" %}selected="selected"{% endif %}>
                                                    Certificate
                                                </option>
                                                <option value="report" {% if document_type == "report" %}selected="selected"{% endif %}>
                                                    Certification Report
                                                </option>
                                                <option value="target" {% if document_type == "target" %}selected="selected"{% endif %}>
                                                    Security Target
                                                </option>
                                            </select>
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <script>
            $(document).ready(function () {
                function searchParams(additional) {
                    let searchType = $("#nameSearchRadioId").is(":checked") ? "byName" : "fulltext"
                    let status = $("#search-status").val();
                    let sort = $("#search-sort").val();
                    let scheme = $("#search-scheme").val();
                    let categories = $.makeArray($("#search-categories input").filter(":checked").map((i, elem) => $(elem).data("id"))).join("");
                    return $.param({searchType, q: $("#search").val(), cat: categories, status: status, sort: sort, scheme: scheme, ...additional});
                }

                function fullSearch() {
                    location.href = "{{ url_for("cc.mergedSearch") }}?" + searchParams();
                }

                function quickSearch() {
                    $.ajax({
                        url: "{{ url_for("cc.search_results") }}?" + searchParams()
                    }).done(function (data) {
                        $("#results").replaceWith(data);
                    });
                }

                function networkSearch() {
                    location.href = "{{ url_for("cc.network") }}?" + searchParams({search: "basic"});
                }

                function nameSearchSetup(){
                    document.getElementById("nameSearchRadioId").checked = true
                    document.getElementById("search-type").disabled = true;
                    document.getElementById("search-sort").disabled = false;
                    const tooltipSort = bootstrap.Tooltip.getInstance('#search-sort-tooltip')
                    tooltipSort.disable()
                    const tooltipType = bootstrap.Tooltip.getInstance('#search-type-tooltip')
                    tooltipType.enable()

                }

                function fulltextSearchSetup(){
                    document.getElementById("fulltextSearchRadioId").checked = true
                    document.getElementById("search-type").disabled = false;
                    document.getElementById("search-sort").disabled = true;
                    const tooltipSort = bootstrap.Tooltip.getInstance('#search-sort-tooltip')
                    tooltipSort.enable()
                    const tooltipType = bootstrap.Tooltip.getInstance('#search-type-tooltip')
                    tooltipType.disable()
                }
                var urlParams = new URLSearchParams(window.location.search);
                if(urlParams.get("searchType") === "byName" || !urlParams.has("searchType")){
                    nameSearchSetup()
                }else if(urlParams.get("searchType") === "fulltext"){
                    fulltextSearchSetup()
                }

                $("#nameSearchRadioId").click(nameSearchSetup);
                $("#fulltextSearchRadioId").click(fulltextSearchSetup);
                $("#search-btn").click(fullSearch);
                $("#network-btn").click(networkSearch);
                // $("#search-categories input").change(quickSearch);
                //$("#search-status").change(quickSearch);
                //$("#search-sort").change(quickSearch);
                //$("#search-scheme").change(quickSearch);
                //$("#search").change(quickSearch);
                $("#search").keyup(function (e) {
                    if (e.keyCode === 13) {
                        fullSearch();
                    } else {
                        //quickSearch();
                    }
                });
                $("#cat-select-all").click(function () {
                    $("#search-categories input").prop("checked", true);
                    //quickSearch();
                });
                $("#cat-deselect-all").click(function () {
                    $("#search-categories input").prop("checked", false);
                    //quickSearch();
                });
            });
            </script>
            {% if searchType == "fulltext" %}
                <div id="pagination" class="table-responsive">
                {% if pagination %}
                    <div style="text-align: center">
                        Took {{ "{:.3}".format(runtime + highlight_runtime) }} seconds
                        {%- if query -%}
                            <span data-bs-toggle="tooltip"
                                  data-bs-html="true"
                                  title="Parsed as <b>{{ query }}</b>">*
                            </span>
                        {%- endif -%}
                        {{ pagination.info }}
                    </div>
                    <div class="mt-4 mb-4">
                        {{ pagination.links }}
                    </div>
                {% endif %}
                {% for result in results %}
                    {% set idd = result["cert"]["heuristics"]["cert_id"]|default("", true) %}
                    {% set hit = result["hit"] %}
                    {% if hit["document_type"] == "cert" %}
                        {% set dtype = "cert-info" %}
                    {% elif hit["document_type"] == "report" %}
                        {% set dtype = "report-info" %}
                    {% elif hit["document_type"] == "target" %}
                        {% set dtype = "st-info" %}
                    {% endif %}
                    <div class="my-5">
                        <table class="table table-bordered table-responsive">
                            <colgroup>
                                <col style="width:20%">
                                <col style="width:60%">
                                <col style="width:10%">
                                <col style="width:10%">
                            </colgroup>
                            <thead>
                            <tr>
                                <td class="pl-1">{{ render_category(result["cert"]["category"]) }}&nbsp;{{ idd }}</td>
                                <td>
                                    <a href="{{ url_for(".entry", hashid=hit["dgst"], _anchor=dtype) }}">{{ hit["name"] }}</a>
                                </td>
                                <td>{{ render_document_type(hit["document_type"]) }}</td>
                                <td>{{ render_status(hit["status"]) }}</td>
                            </tr>
                            </thead>
                            <tbody style="border-top-color: #dfe0e1">
                            {% if "highlights" in result %}
                                <tr>
                                    <td colspan="4">
                                        {{ result["highlights"]|safe }}
                                    </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                {% endfor %}
                {% if pagination %}
                    <div class="mb-4">
                        {{ pagination.links }}
                    </div>
                {% endif %}
                </div>
            {% elif searchType == "byName" %}
                <div id="results">
                    {{ render_pagination(pagination, certs, search=True) }}
                    {{ render_plot(timeline) }}
                </div>
            {% endif %}
        </div>
    </main>
{% endblock %}