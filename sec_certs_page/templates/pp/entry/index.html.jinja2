{% extends "common/base.html.jinja2" %}
{% set canonical = True %}
{% from "include/modals.html.jinja2" import compare_icon, chat_icon, chat_modal with context %}
{% from "include/entry.html.jinja2" import cryptography_keywords, device_keywords, security_keywords, other_keywords, render_local_report, render_local_profile, render_pdf_meta, render_updates, render_update_feed_button, render_raw_data, render_raw_data_button %}
{% from "cc/include.html.jinja2" import cc_keywords, render_eal, render_status, render_sars, render_sfrs, render_category %}
{% from "include/utils.html.jinja2" import render_process_state, render_share_buttons, notification_icon, notification_script with context %}

{% block title %}
    <title>
        {{ profile["web_data"]["name"]|default("", true) + " | sec-certs.org" }}
    </title>
{% endblock %}
{% block metadata %}
    <meta property="twitter:card" content="summary"/>
    <meta property="twitter:site" content="@CRoCS_MUNI"/>
    <meta property="twitter:title" content="{{ profile["web_data"]["name"]|default("sec-certs.org", true) }}"/>
    <meta property="twitter:image" content="{{ url_for("static", filename="img/pp_card.png", _external=True) }}"/>
    <meta property="twitter:description"
          content="Common Criteria protection profile {{ profile["web_data"]["name"]|default("", true) }}"/>
    <meta property="og:title" content="{{ profile["web_data"]["name"]|default("sec-certs.org", true) }}"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="{{ url_for(".entry", hashid=hashid, _external=True) }}"/>
    <meta property="og:image" content="{{ url_for("static", filename="img/pp_card.png", _external=True) }}"/>
    <meta property="og:description"
          content="Common Criteria protection profile {{ profile["web_data"]["name"]|default("", true) }}"/>
    <meta property="og:site_name" content="sec-certs.org"/>
{% endblock %}

{% block left_navigation %}
    <div id="left-navigation" class="d-none d-md-block list-group list-group-flush list-group-numbered">
        <h4>Sections</h4>
        <a class="list-group-item list-group-item-action rounded" href="#web-info">Web information</a>
        <a class="list-group-item list-group-item-action rounded" href="#report-info">Report</a>
        <a class="list-group-item list-group-item-action rounded" href="#profile-info">Profile</a>
        <a class="list-group-item list-group-item-action rounded" href="#reference-graph">References</a>
        <a class="list-group-item list-group-item-action rounded" href="#updates">Updates</a>
        <a class="list-group-item list-group-item-action rounded" href="#raw-data-head">Raw data</a>
    </div>
{% endblock %}

{% block content %}
    <main data-bs-spy="scroll" data-bs-target="#left-navigation" data-bs-smooth-scroll="false" tabindex="0"
          class="shifted-section">
        <div class="row">
            <div class="col-12 col-sm-10 p-3 py-md-5">
                <div class="alert alert-warning d-sm-none" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> This page was not yet optimized for use on mobile
                    devices.
                </div>
                <div>
                    <h1>{{ profile["web_data"]["name"]|default("") }}</h1>
                    <div class="d-flex gap-3 flex-wrap">
                        {{ compare_icon() }}
                        {{ notification_icon(current_user, subscribed) }}
                        {{ render_share_buttons(hashid, cert_id=None, name=profile["web_data"]["name"]) }}
                    </div>

                    {% if "web_data" in profile %}
                        <div class="row pt-5" id="web-info">
                            <div class="col-12 col-md-6">
                                <h2 class="anchor">Web information</h2>
                                <table class="table table-sm table-borderless w-auto">
                                    <colgroup>
                                        <col style="width: 30%"/>
                                        <col style="width: 70%"/>
                                    </colgroup>
                                    <tbody>
                                    <tr data-cs-name="Certificate status">
                                        <th scope="row">Status</th>
                                        <td>{{ render_status(profile["web_data"]["status"]) }}</td>
                                    </tr>
                                    <tr data-cs-name="Valid from">
                                        <th scope="row">Valid from</th>
                                        <td>{{ profile["web_data"]["not_valid_before"]|strftime("%d.%m.%Y") }}</td>
                                    </tr>
                                    {% if profile["web_data"]["not_valid_after"] %}
                                        <tr data-cs-name="Valid until">
                                            <th scope="row">Valid until</th>
                                            <td>{{ profile["web_data"]["not_valid_after"]|strftime("%d.%m.%Y") }}</td>
                                        </tr>
                                    {% endif %}
                                    <tr data-cs-name="Certification scheme">
                                        <th scope="row">Scheme</th>
                                        <td>{{ country_to_flag(profile['web_data']["scheme"]) }} {{ profile['web_data']['scheme'] }}</td>
                                    </tr>
                                    <tr data-cs-name="Category">
                                        <th scope="row">Category</th>
                                        <td>{{ render_category((profile["web_data"]["category"])) }} {{ profile["web_data"]["category"] }}</td>
                                    </tr>
                                    <tr data-cs-name="Security level">
                                        <th scope="row">Security level</th>
                                        <td>
                                            {% for level in profile["web_data"]["security_level"] %}
                                                {{ render_eal(level) }}{%- if not loop.last -%}, {%- endif -%}
                                            {% endfor %}
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="row bg-darker-light">
            <div class="col-12 col-sm-10 p-3">
                <div class="mb-5">
                    <div id="report-info" class="mt-5 mb-3">
                        <h2 class="anchor">Certification report
                        </h2>
                        {{ render_process_state(profile["state"], "report", "certification report") }}
                        {% if profile["web_data"]["report_link"] %}
                            <div class="mt-3 mb-3">
                                {{ render_local_report(hashid, local_files, profile["web_data"]["report_link"], primary_style="btn-primary", secondary_style="btn-secondary") }}
                            </div>
                        {% endif %}

                        {% if profile["pdf_data"]["report_keywords"] %}
                            <h3 class="mt-3">Extracted keywords</h3>
                            {{ cryptography_keywords(profile["pdf_data"]["report_keywords"], "report") }}
                            {{ device_keywords(profile["pdf_data"]["report_keywords"], "report") }}
                            {{ cc_keywords(profile["pdf_data"]["report_keywords"], "report", map_funcs={"cc_sar": render_sars,
                                                                                                "cc_sfr": render_sfrs}) }}
                            {{ security_keywords(profile["pdf_data"]["report_keywords"], "report") }}
                            {{ other_keywords(profile["pdf_data"]["report_keywords"], "report") }}
                        {% endif %}
                        {% if profile["pdf_data"]["report_metadata"] %}
                            <h3 class="mt-3">File metadata</h3>
                            {{ render_pdf_meta(profile["pdf_data"]["report_metadata"], "Certification report") }}
                        {% endif %}
                    </div>

                    <div id="profile-info" class="mt-5 mb-3">
                        <h2 class="anchor">Protection Profile</h2>
                        {{ render_process_state(profile["state"], "pp", "protection profile") }}

                        {% if profile["web_data"]["pp_link"] %}
                            <div class="mt-3 mb-3">
                                {{ render_local_profile(hashid, local_files, profile["web_data"]["pp_link"], primary_style="btn-primary", secondary_style="btn-secondary") }}
                            </div>
                        {% endif %}

                        {% if profile["pdf_data"]["pp_keywords"] %}
                            <h3 class="mt-3">Extracted keywords</h3>
                            {{ cryptography_keywords(profile["pdf_data"]["pp_keywords"], "profile") }}
                            {{ device_keywords(profile["pdf_data"]["pp_keywords"], "profile") }}
                            {{ cc_keywords(profile["pdf_data"]["pp_keywords"], "profile", map_funcs={"cc_sar": render_sars,
                                                                                                "cc_sfr": render_sfrs}) }}
                            {{ security_keywords(profile["pdf_data"]["pp_keywords"], "profile") }}
                            {{ other_keywords(profile["pdf_data"]["pp_keywords"], "profile") }}
                        {% endif %}
                        {% if profile["pdf_data"]["pp_metadata"] %}
                            <h3 class="mt-3">File metadata</h3>
                            {{ render_pdf_meta(profile["pdf_data"]["pp_metadata"], "Protection profile") }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-12 col-sm-10">
                <div id="reference-graph" class="mt-3 mb-5">
                    <h2 class="anchor">References</h2>
                    <div>
                        {% if certs %}
                            <ul>
                                {% for cert in certs %}
                                    <li>
                                        <a href="{{ url_for('cc.entry', hashid=cert['_id']) }}">{{ cert['name'] }}</a>
                                        {{ render_status(cert["status"]) }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No references are available for this protection profile.</p>
                        {% endif %}
                    </div>
                </div>
                <div id="updates" class="mt-5 mb-5">
                    <h2 class="anchor">Updates
                        {{ render_update_feed_button(hashid) }}
                    </h2>

                    {{ render_updates("protection profile", diffs, diff_jsons, diff_renders) }}
                </div>
                <div id="raw-data-head" class="mt-5 mb-5">
                    <h2 class="anchor">Raw data
                        {{ render_raw_data_button(hashid) }}
                    </h2>
                    {{ render_raw_data(json) }}
                </div>
            </div>
        </div>
        <script type="module">
            import {copyLinkToClipboard} from "/static/clipboard.js?{{ static_hash("clipboard.js") }}";

            $(".copy-on-click").on("click", function (e) {
                e.preventDefault();
                copyLinkToClipboard($(this));
            });

            window.certificate_data = {
                name: "{{ profile["web_data"]["name"]|default("", true) }}",
                hashid: "{{ hashid }}",
                type: "pp",
                url: "{{ url_for("pp.entry", hashid=hashid) }}"
            };
        </script>
        {{ notification_script(csrf_token) }}
    </main>
    {% if config["CHAT_ENABLED"] %}
        {{ chat_modal() }}
    {% endif %}
{% endblock %}

{% block footer %}
    {{ super() }}
    {% if config["CHAT_ENABLED"] %}
        {{ chat_icon() }}
    {% endif %}
{% endblock %}
