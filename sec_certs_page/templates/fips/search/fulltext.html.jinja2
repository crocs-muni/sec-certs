{% extends "base.html.jinja2" %}
{% set crumbs = True %}
{% set search = True %}
{% from "fips/utils.html.jinja2" import render_status, render_type, render_document_type %}
{% block content %}
    <main>
        <div class="col-10 mx-auto p-3 py-md-5">
            <div class="alert alert-warning d-sm-none" role="alert">
                <i class="fas fa-exclamation-triangle"></i> This page was not yet optimized for use on mobile devices.
            </div>
            <h1>FIPS</h1>
            <h3 class="text-secondary">Fulltext search <span
                    class="badge bg-warning text-dark"><i class="fas fa-flask"></i> Experimental feature</span></h3>
            <div class="card mt-3 mt-4 mb-4">
                <div class="card-body container">
                    <div id="name" class="mt-1 mb-3">
                        <h4><label for="search">Query</label></h4>
                        <div class="form-inline">
                            <input id="search" class="form-control mb-2" placeholder="Search" type="search"
                                   value="{{ q|default('', true) }}"/>
                            <button id="search-btn" class="btn btn-primary">Search</button>
                        </div>
                        <small class="text-muted">Search certificate reports and security policies.
                            Supports the <a href="https://whoosh.readthedocs.io/en/latest/querylang.html"
                                            target="_blank" rel="noopener">Whoosh query language</a>.</small>
                    </div>
                    <div id="categories" class="mt-3 mb-3">
                        <h4>Categories</h4>
                        <button id="cat-select-all" class="btn btn-outline-primary">Select all</button>
                        <button id="cat-deselect-all" class="btn btn-outline-primary">Deselect all</button>
                        <div id="search-categories" class="row">
                            {% for name, val in categories.items() %}
                                {% if loop.index0 % 3 == 0 %}
                                    <div class="col">
                                {% endif %}
                            <div class="form-check">
                                    <span>
                                        <input id="category-{{ val['id'] }}" type="checkbox" class="form-check-input"
                                               data-id="{{ val['id'] }}" {% if val["selected"] %}checked{% endif %}>
                                        <label class="form-check-label" for="category-{{ val['id'] }}">
                                            <i class="fas fa-fw {{ val['icon'] }}"></i> {{ name }}
                                        </label>
                                    </span>
                            </div>
                            {% if (loop.index0 + 1) % 3 == 0 %}
                                </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mt-3 mb-3">
                        <h4><label for="search-status">Status</label></h4>
                        <select id="search-status" class="form-control">
                            <option value="Any" {% if status == "Any" %}selected="selected"{% endif %}>Any</option>
                            <option value="Active" class="text-success"
                                    {% if status == "active" %}selected="selected"{% endif %}>Active
                            </option>
                            <option value="Historical" class="text-warning"
                                    {% if status == "Historical" %}selected="selected"{% endif %}>Historical
                            </option>
                            <option value="Revoked" class="text-danger"
                                    {% if status == "Revoked" %}selected="selected"{% endif %}>Revoked
                            </option>
                        </select>
                    </div>
                    <div class="mt-3 mb-3">
                        <h4><label for="search-type">Document type</label></h4>
                        <select id="search-type" class="form-control">
                            <option value="any" {% if document_type == "any" %}selected="selected"{% endif %}>Any
                            </option>
                            <option value="report" {% if document_type == "report" %}selected="selected"{% endif %}>
                                Certification Report
                            </option>
                            <option value="target" {% if document_type == "target" %}selected="selected"{% endif %}>
                                Security Policy
                            </option>
                        </select>
                    </div>
                </div>
            </div>
            <script>
                function searchParams() {
                    let status = $("#search-status").val();
                    let document_type = $("#search-type").val();
                    let categories = $.makeArray($("#search-categories input").filter(":checked").map((i, elem) => $(elem).data("id"))).join("");
                    return $.param({q: $("#search").val(), cat: categories, status: status, type: document_type});
                }

                function fullSearch() {
                    location.href = "{{ url_for(".fulltext_search") }}?" + searchParams();
                }

                $("#search-btn").click(fullSearch);
                $("#search").keyup(function (e) {
                    if (e.keyCode === 13) {
                        fullSearch();
                    }
                });
                $("#cat-select-all").click(function () {
                    $("#search-categories input").prop("checked", true);
                });
                $("#cat-deselect-all").click(function () {
                    $("#search-categories input").prop("checked", false);
                });
            </script>
            <div id="pagination">
                {% if pagination %}
                    <div style="text-align: center">
                        Took {{ "{:.3}".format(runtime + highlight_runtime) }} seconds
                        {{ pagination.info }}
                    </div>
                    <div class="mt-4 mb-4">
                        {{ pagination.links }}
                    </div>
                {% endif %}
                {% for result in results %}
                    {% set idd = result["cert"]["cert_id"]|default("", true) %}
                    <div class="my-5">
                        <table class="table table-bordered table-light table-responsive">
                            <colgroup>
                                <col style="width:10%">
                                <col style="width:70%">
                                <col style="width:10%">
                                <col style="width:10%">
                            </colgroup>
                            <thead style="border-top-color: #dfe0e1">
                            <tr>
                                <td class="pl-1">{{ render_type(result["cert"]["web_data"]["module_type"]) }}&nbsp;#{{ idd }}</td>
                                <td>
                                    <a href="{{ url_for(".entry", hashid=result["hit"]["dgst"]) }}">{{ result["hit"]["name"] }}</a>
                                </td>
                                <td>{{ render_document_type(result["hit"]["document_type"]) }}</td>
                                <td>{{ render_status(result["hit"]["status"]) }}</td>
                            </tr>
                            </thead>
                            <tbody style="border-top-color: #dfe0e1">
                            {% if "highlights" in result %}
                                <tr>
                                    <td colspan="4">
                                        {{ result["highlights"]|safe }}
                                    </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                {% endfor %}
                {% if pagination %}
                    <div class="mb-4">
                        {{ pagination.links }}
                    </div>
                {% endif %}
            </div>
        </div>
    </main>
{% endblock %}